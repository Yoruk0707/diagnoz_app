// DiagnozApp — Firestore Security Rules
//
// NEDEN: database_schema.md § Security bölümünden + security review düzeltmeleri.
// CLAUDE.md § Firebase Security Rules ile uyumlu.
//
// Kural özeti:
//   users:              get=auth, list=false, write=owner only, delete=never
//   games:              read=owner, create/update=owner+validation, delete=never
//   cases:              read=auth, write=never (admin via Cloud Functions)
//   leaderboard_weekly: read=auth, create/update=owner, delete=never
//   leaderboard_monthly: read=auth, create/update=owner, delete=never

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ───

    // NEDEN: DRY — auth kontrolü tekrar tekrar yazılmasın.
    function isAuth() {
      return request.auth != null;
    }

    // NEDEN: Sadece kendi verini değiştirebilsin (userId eşleşmesi).
    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // NEDEN: Kullanıcı dokümanında izin verilen top-level field'lar.
    // Allowlist dışındaki field'lar (ör. isAdmin) client'tan yazılamaz.
    // stats: nested object (stats.totalGamesPlayed, stats.weeklyScore vb.)
    function isValidUserFields() {
      return request.resource.data.keys().hasOnly([
        'displayName', 'university', 'phoneNumber',
        'createdAt', 'updatedAt', 'stats'
      ]);
    }

    // NEDEN: Oyun dokümanında izin verilen field'lar.
    // GameModel.toFirestore() çıktısıyla birebir eşleşmeli.
    // Client manipülasyonunu sınırla — sadece bilinen field'lar.
    function isValidGameFields() {
      return request.resource.data.keys().hasOnly([
        'userId', 'mode', 'status', 'startTime', 'endTime',
        'totalScore', 'casesCompleted', 'totalCases', 'cases',
        'passesLeft'
      ]);
    }

    // NEDEN: Leaderboard dokümanında izin verilen field'lar.
    // submitGame batch write'ıyla birebir eşleşmeli.
    function isValidLeaderboardFields() {
      return request.resource.data.keys().hasOnly([
        'userId', 'displayName', 'university',
        'score', 'casesPlayed', 'gamesPlayed',
        'weekNumber', 'month', 'year', 'lastUpdated'
      ]);
    }

    // ─── users/{userId} ───
    // NEDEN: get = auth (tek profil okuma, leaderboard'da displayName için).
    // list = false (tüm kullanıcıları listeleme engeli — enumeration koruması).
    // Anonim scraping engellenir: isAuth() ile.
    // Field allowlist: isValidUserFields() ile bilinmeyen field yazılamaz.
    // Delete kapalı — hesap silme Cloud Functions'dan yapılır.
    match /users/{userId} {
      allow get: if isAuth();
      allow list: if false;
      allow create: if isAuth() && isOwner(userId) && isValidUserFields();
      allow update: if isAuth() && isOwner(userId) && isValidUserFields();
      allow delete: if false;
    }

    // ─── games/{gameId} ───
    // NEDEN: Oyun geçmişi sadece sahibi okuyabilir (gizlilik).
    // Create: oyun başlatma (in_progress status).
    // Update: oyun tamamlama (batch.set ile final data yazılır).
    // Delete kapalı — oyun sonuçları immutable (database_schema.md).
    // totalScore 0-60, casesCompleted 0-5 validasyonu.
    match /games/{gameId} {
      allow read: if isAuth() && isOwner(resource.data.userId);
      allow create: if isAuth()
        && isOwner(request.resource.data.userId)
        && isValidGameFields();
      // NEDEN: batch.set() existing doc üzerine yazınca update permission gerekir.
      // submitGame atomic batch write'ında in_progress → completed güncellenir.
      allow update: if isAuth()
        && isOwner(resource.data.userId)
        && isValidGameFields()
        && request.resource.data.totalScore >= 0
        && request.resource.data.totalScore <= 60;
      allow delete: if false;
    }

    // ─── cases/{caseId} ───
    // NEDEN: Vakalar sadece auth kullanıcılar okuyabilir (scraping azaltma).
    // Write tamamen kapalı — sadece admin Cloud Functions ile ekler.
    // correctDiagnosis bu koleksiyonda YOKTUR — cases_private'ta saklanır.
    match /cases/{caseId} {
      allow read: if isAuth();
      allow write: if false;
    }

    // ─── cases_private/{caseId} ───
    // NEDEN: correctDiagnosis + alternativeDiagnoses burada saklanır.
    // DevTools ile cases koleksiyonunu inceleyen öğrenci doğru cevabı göremez.
    // get-only: Tek tek document okuma izni — toplu query (list) KAPALI.
    // NEDEN: list açık olursa auth kullanıcı tüm cases_private'ı whereIn/query
    // ile toplu çekip tüm doğru cevapları görebilir. get-only ile sadece
    // bildiği caseId'yi tek tek okuyabilir.
    // Write kapalı — sadece seed/Cloud Functions.
    // Tam güvenlik ileride Cloud Function ile sağlanacak — bu MVP ara çözümü.
    match /cases_private/{caseId} {
      allow get: if isAuth();
      allow list: if false;
      allow write: if false;
    }

    // ─── leaderboard_weekly/{docId} ───
    // NEDEN: MVP'de client batch write ile leaderboard güncellenir.
    // FieldValue.increment ile atomic score update.
    // Sadece kendi userId'sine yazabilir — başkasının skorunu değiştiremez.
    // Field allowlist ile bilinmeyen field enjeksiyonu engellenir.
    // Production'da Cloud Functions'a taşındığında write kapatılacak.
    match /leaderboard_weekly/{docId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && isOwner(request.resource.data.userId)
        && isValidLeaderboardFields();
      allow update: if isAuth()
        && isOwner(resource.data.userId)
        && isValidLeaderboardFields();
      allow delete: if false;
    }

    // ─── leaderboard_monthly/{docId} ───
    // NEDEN: leaderboard_weekly ile aynı kurallar.
    match /leaderboard_monthly/{docId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && isOwner(request.resource.data.userId)
        && isValidLeaderboardFields();
      allow update: if isAuth()
        && isOwner(resource.data.userId)
        && isValidLeaderboardFields();
      allow delete: if false;
    }
  }
}
